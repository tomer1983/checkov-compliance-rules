---
metadata:
  id: "CKV_EKS_CUSTOM_007"
  name: "Ensure ALB Ingress uses HTTPS listener"
  category: "AWS_EKS_NETWORKING"
  severity: "HIGH"
  guideline: "ALB Ingresses should use HTTPS to encrypt traffic in transit."
definition:
  cond_type: "attribute"
  resource_types:
    - "Ingress"
  attribute: "metadata.annotations.alb.ingress.kubernetes.io/certificate-arn"
  operator: "exists"

---
metadata:
  id: "CKV_EKS_CUSTOM_008"
  name: "Ensure ALB Ingress has SSL redirect enabled"
  category: "AWS_EKS_NETWORKING"
  severity: "MEDIUM"
  guideline: "Redirect HTTP traffic to HTTPS for better security."
definition:
  cond_type: "attribute"
  resource_types:
    - "Ingress"
  attribute: "metadata.annotations.alb.ingress.kubernetes.io/ssl-redirect"
  operator: "equals"
  value: "443"

---
metadata:
  id: "CKV_EKS_CUSTOM_009"
  name: "Ensure ALB has proper security group configuration"
  category: "AWS_EKS_NETWORKING"
  severity: "MEDIUM"
  guideline: "ALB should have security groups defined for proper network isolation."
definition:
  cond_type: "attribute"
  resource_types:
    - "Ingress"
  attribute: "metadata.annotations.alb.ingress.kubernetes.io/security-groups"
  operator: "exists"

---
metadata:
  id: "CKV_EKS_CUSTOM_010"
  name: "Ensure ALB targets are in internal subnet for private services"
  category: "AWS_EKS_NETWORKING"
  severity: "MEDIUM"
  guideline: "Internal ALBs should be deployed in private subnets for better security."
definition:
  cond_type: "attribute"
  resource_types:
    - "Ingress"
  attribute: "metadata.annotations.alb.ingress.kubernetes.io/scheme"
  operator: "equals"
  value: "internal"

---
metadata:
  id: "CKV_EKS_CUSTOM_011"
  name: "Ensure ALB has WAF enabled"
  category: "AWS_EKS_NETWORKING"
  severity: "MEDIUM"
  guideline: "Web Application Firewall (WAF) provides protection against common web exploits."
definition:
  cond_type: "attribute"
  resource_types:
    - "Ingress"
  attribute: "metadata.annotations.alb.ingress.kubernetes.io/wafv2-acl-arn"
  operator: "exists"

---
metadata:
  id: "CKV_EKS_CUSTOM_012"
  name: "Ensure NLB has cross-zone load balancing enabled"
  category: "AWS_EKS_NETWORKING"
  severity: "LOW"
  guideline: "Cross-zone load balancing improves availability and distributes traffic evenly."
definition:
  cond_type: "attribute"
  resource_types:
    - "Service"
  attribute: "metadata.annotations.service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled"
  operator: "equals"
  value: "true"

---
metadata:
  id: "CKV_EKS_CUSTOM_013"
  name: "Ensure LoadBalancer service uses NLB with internal scheme for private APIs"
  category: "AWS_EKS_NETWORKING"
  severity: "MEDIUM"
  guideline: "Internal services should use internal load balancers to prevent public exposure."
definition:
  and:
    - cond_type: "attribute"
      resource_types:
        - "Service"
      attribute: "spec.type"
      operator: "equals"
      value: "LoadBalancer"
    - cond_type: "attribute"
      resource_types:
        - "Service"
      attribute: "metadata.annotations.service.beta.kubernetes.io/aws-load-balancer-internal"
      operator: "equals"
      value: "true"
