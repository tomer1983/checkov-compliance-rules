---
metadata:
  id: "CKV_K8S_CUSTOM_001"
  name: "Ensure container does not run as root user"
  category: "KUBERNETES_SECURITY"
  severity: "HIGH"
  guideline: "Running containers as root increases the risk of privilege escalation attacks. Set runAsNonRoot to true in securityContext."
definition:
  and:
    - cond_type: "attribute"
      resource_types:
        - "Pod"
        - "Deployment"
        - "StatefulSet"
        - "DaemonSet"
        - "Job"
        - "CronJob"
        - "ReplicaSet"
      attribute: "spec.containers[*].securityContext.runAsNonRoot"
      operator: "exists"
    - cond_type: "attribute"
      resource_types:
        - "Pod"
        - "Deployment"
        - "StatefulSet"
        - "DaemonSet"
        - "Job"
        - "CronJob"
        - "ReplicaSet"
      attribute: "spec.containers[*].securityContext.runAsNonRoot"
      operator: "equals"
      value: true

---
metadata:
  id: "CKV_K8S_CUSTOM_002"
  name: "Ensure container does not run in privileged mode"
  category: "KUBERNETES_SECURITY"
  severity: "CRITICAL"
  guideline: "Privileged containers have access to all devices on the host and can bypass most security features. Set privileged to false."
definition:
  or:
    - cond_type: "attribute"
      resource_types:
        - "Pod"
        - "Deployment"
        - "StatefulSet"
        - "DaemonSet"
        - "Job"
        - "CronJob"
        - "ReplicaSet"
      attribute: "spec.containers[*].securityContext.privileged"
      operator: "not_exists"
    - cond_type: "attribute"
      resource_types:
        - "Pod"
        - "Deployment"
        - "StatefulSet"
        - "DaemonSet"
        - "Job"
        - "CronJob"
        - "ReplicaSet"
      attribute: "spec.containers[*].securityContext.privileged"
      operator: "equals"
      value: false

---
metadata:
  id: "CKV_K8S_CUSTOM_003"
  name: "Ensure containers drop all capabilities"
  category: "KUBERNETES_SECURITY"
  severity: "HIGH"
  guideline: "Dropping all Linux capabilities reduces the attack surface by removing unnecessary privileges from containers."
definition:
  cond_type: "attribute"
  resource_types:
    - "Pod"
    - "Deployment"
    - "StatefulSet"
    - "DaemonSet"
    - "Job"
    - "CronJob"
    - "ReplicaSet"
  attribute: "spec.containers[*].securityContext.capabilities.drop[*]"
  operator: "contains"
  value: "ALL"

---
metadata:
  id: "CKV_K8S_CUSTOM_004"
  name: "Ensure containers use read-only root filesystem"
  category: "KUBERNETES_SECURITY"
  severity: "MEDIUM"
  guideline: "Using a read-only root filesystem prevents malicious code from modifying the container's filesystem."
definition:
  and:
    - cond_type: "attribute"
      resource_types:
        - "Pod"
        - "Deployment"
        - "StatefulSet"
        - "DaemonSet"
        - "Job"
        - "CronJob"
        - "ReplicaSet"
      attribute: "spec.containers[*].securityContext.readOnlyRootFilesystem"
      operator: "exists"
    - cond_type: "attribute"
      resource_types:
        - "Pod"
        - "Deployment"
        - "StatefulSet"
        - "DaemonSet"
        - "Job"
        - "CronJob"
        - "ReplicaSet"
      attribute: "spec.containers[*].securityContext.readOnlyRootFilesystem"
      operator: "equals"
      value: true

---
metadata:
  id: "CKV_K8S_CUSTOM_005"
  name: "Ensure containers do not allow privilege escalation"
  category: "KUBERNETES_SECURITY"
  severity: "HIGH"
  guideline: "Prevent containers from gaining more privileges than their parent process by setting allowPrivilegeEscalation to false."
definition:
  or:
    - cond_type: "attribute"
      resource_types:
        - "Pod"
        - "Deployment"
        - "StatefulSet"
        - "DaemonSet"
        - "Job"
        - "CronJob"
        - "ReplicaSet"
      attribute: "spec.containers[*].securityContext.allowPrivilegeEscalation"
      operator: "equals"
      value: false
    - and:
        - cond_type: "attribute"
          resource_types:
            - "Pod"
            - "Deployment"
            - "StatefulSet"
            - "DaemonSet"
            - "Job"
            - "CronJob"
            - "ReplicaSet"
          attribute: "spec.securityContext.runAsNonRoot"
          operator: "equals"
          value: true
        - cond_type: "attribute"
          resource_types:
            - "Pod"
            - "Deployment"
            - "StatefulSet"
            - "DaemonSet"
            - "Job"
            - "CronJob"
            - "ReplicaSet"
          attribute: "spec.containers[*].securityContext.allowPrivilegeEscalation"
          operator: "not_exists"

---
metadata:
  id: "CKV_K8S_CUSTOM_006"
  name: "Ensure pod securityContext is defined with runAsUser > 10000"
  category: "KUBERNETES_SECURITY"
  severity: "MEDIUM"
  guideline: "Running containers with high UID numbers reduces the risk of conflicts with host users and improves security."
definition:
  and:
    - cond_type: "attribute"
      resource_types:
        - "Pod"
        - "Deployment"
        - "StatefulSet"
        - "DaemonSet"
        - "Job"
        - "CronJob"
        - "ReplicaSet"
      attribute: "spec.securityContext.runAsUser"
      operator: "exists"
    - cond_type: "attribute"
      resource_types:
        - "Pod"
        - "Deployment"
        - "StatefulSet"
        - "DaemonSet"
        - "Job"
        - "CronJob"
        - "ReplicaSet"
      attribute: "spec.securityContext.runAsUser"
      operator: "greater_than"
      value: 10000
