---
metadata:
  id: "CKV_K8S_CUSTOM_016"
  name: "Ensure container image is not using latest tag"
  category: "KUBERNETES_CONFIGURATION"
  severity: "MEDIUM"
  guideline: "Using 'latest' tag can lead to unpredictable deployments. Always use specific version tags or digests."
definition:
  cond_type: "attribute"
  resource_types:
    - "Pod"
    - "Deployment"
    - "StatefulSet"
    - "DaemonSet"
    - "Job"
    - "CronJob"
    - "ReplicaSet"
  attribute: "spec.containers[*].image"
  operator: "not_regex_match"
  value: ".*:latest$|^[^:]+$"

---
metadata:
  id: "CKV_K8S_CUSTOM_017"
  name: "Ensure imagePullPolicy is set to Always or IfNotPresent"
  category: "KUBERNETES_CONFIGURATION"
  severity: "LOW"
  guideline: "Proper imagePullPolicy ensures consistent and secure image usage across deployments."
definition:
  cond_type: "attribute"
  resource_types:
    - "Pod"
    - "Deployment"
    - "StatefulSet"
    - "DaemonSet"
    - "Job"
    - "CronJob"
    - "ReplicaSet"
  attribute: "spec.containers[*].imagePullPolicy"
  operator: "within"
  value:
    - "Always"
    - "IfNotPresent"

---
metadata:
  id: "CKV_K8S_CUSTOM_018"
  name: "Ensure container image uses trusted registry"
  category: "KUBERNETES_CONFIGURATION"
  severity: "HIGH"
  guideline: "Using images from trusted registries prevents supply chain attacks and ensures image integrity."
definition:
  cond_type: "attribute"
  resource_types:
    - "Pod"
    - "Deployment"
    - "StatefulSet"
    - "DaemonSet"
    - "Job"
    - "CronJob"
    - "ReplicaSet"
  attribute: "spec.containers[*].image"
  operator: "regex_match"
  value: "^(gcr\\.io|[a-z0-9-]+\\.azurecr\\.io|[0-9]+\\.dkr\\.ecr\\.[a-z0-9-]+\\.amazonaws\\.com|quay\\.io|docker\\.io)/.*"
